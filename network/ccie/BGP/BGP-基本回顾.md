# BGP 协议基本回顾

BGP 协议-边界网关组播协议。各自治系统（AS）中运行的 OSPF（其所能承载的路由信息大约为 5w 条左右） 等 AS 内部运行的路由协议无法跨 AS 通信，各 AS 之间的路由通信则需要依靠 BGP 协议。

## 1 相关问题

### 1.1 BGP 协议的本质

- 是一个四层协议：E => IP => TCP => Data
- 类似的还有 HTTP 协议：E => ip => TCP => HTTP

通过 TCP 的不同端口号来区分不同的上层协议，BGP 的端口号为 179（目标端口）。发起方以随机的源端口和目标端口根据目标端口固定的协议建立连接。

### 1.2 BGP 的更新机制

能 PING 通服务器就代表能访问 HTTP 吗？

- PING 使用的是 ICMP 协议，能 PING 通不代表能访问 80 端口的 HTTP 协议
- PING 通说明控制层面（路由表的形成）的路由没有问题，80 端口访问不了是数据层面（数据包）的错误。典型错误是防火墙干掉了 80 端口
- 一个网络如果发生拥塞，OSPF 的包一般不会，因为路由表是网络访问的基础

路由表更新方式有：

- 周期性更新
- 触发式更新

常用路由协议：

- RIP 周期性泛洪更新路由表，但是如果某个节点坏掉了，也会触发更新
- OSPF 也有周期性更新和触发更新
- BGP 只有触发更新，没有周期性更新。因为 BGP 运行在很大的网络中，全量刷新不好整

### 1.3 BGP 三张表

- 邻居表 adjancy table
  - BGP 邻居建立不起来的主要原因
    - 没有路由
    - AS 指错
    - IP 地址指错
    - TCP 数据报文过滤（179 端口被防火墙过滤掉了）
    - 验证
- 转发表 forwarding database： 到达目标路由的所有可能性
- 路由表 routing table:  转发表根据选择原则选出一条最牛逼的放到路由表

### 1.4 BGP 报文及理解

BGP 报文

- OPEN
- KEEP ALIVE
- UPDATE
- NOTIFICATION

没有 HELLO 报文，HELLO 报文在其他路由协议中用于建立、维持（三次不回应认为挂掉）邻居。BGP 中使用 OPEN/KEEPALIVE 报文代替了 HELLO 报文。

### 1.5 BGP 建立邻居的正常状态和不正常状态

正常状态

不正常状态

### 1.6 BGP 不正常状态的可能原因

同 BGP 的邻居建立不起来的原因

## 2 BGP 的特性

- 可靠的路由更新机制
- 触发式增量更新
- 周期性的 keepalive 信息保证 TCP 的连接是否存活
- 丰富的 metric 标准，属性（称之为距离矢量或属性）
  - 如 RIP 考虑跳数
  - OSPF 只跟带宽有关系
  - BGP 选路属性有 13 种
- 工作在 internet
